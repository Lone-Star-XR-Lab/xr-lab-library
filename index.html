<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lone Star XR Lab - App Library</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    @media print {
      body { background: #fff !important; color: #000 !important; }
      .no-print { display: none !important; }
      .grid { display: block !important; }
      .grid > * { break-inside: avoid; margin-bottom: 1rem; }
      .shadow-sm, .shadow, .shadow-lg { box-shadow: none !important; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900" x-data="app()" x-init="loadData()">
  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex items-start justify-between gap-3">
      <h1 class="text-3xl font-bold">Lone Star XR Lab - App Library</h1>
      <p class="text-xs text-gray-500 no-print">
        <span class="underline decoration-dotted cursor-help" title="XR is an umbrella term for VR, AR, and MR.">What is XR?</span>
      </p>
    </div>

    <!-- Fixed banner -->
    <div class="no-print my-4">
      <div class="rounded-lg border border-blue-300 bg-blue-50 text-blue-900 px-4 py-3">
        <p class="font-semibold">Only showing apps that are <em>Approved</em> or <em>Installed</em>.</p>
        <p class="text-sm">Items with both <code>approved: false</code> and <code>installed: false</code> are hidden.</p>
      </div>
    </div>

    <!-- Controls -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-3 no-print" x-show="apps.length">
      <div class="md:col-span-2">
        <label class="block text-xs text-gray-600 mb-1">Department</label>
        <select x-model="department" class="w-full border px-3 py-2 rounded-md shadow-sm">
          <option value="">All Departments</option>
          <template x-for="opt in departmentOptions" :key="opt">
            <option :value="opt" x-text="deptOptionLabel(opt)"></option>
          </template>
        </select>
      </div>
      <div class="md:col-span-2">
        <label class="block text-xs text-gray-600 mb-1">Search</label>
        <input type="text" x-model="query" placeholder="Title, notes, tagsâ€¦" class="w-full border px-3 py-2 rounded-md shadow-sm">
      </div>
      <div class="md:col-span-1">
        <label class="block text-xs text-gray-600 mb-1">Sort</label>
        <select x-model="sortMode" class="border px-3 py-2 rounded-md shadow-sm w-full">
          <option value="az">Title Aâ€“Z</option>
          <option value="za">Title Zâ€“A</option>
        </select>

        <!-- Optional toggles (refine within the approved/installed-only set) -->
        <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
          <label class="flex items-center gap-2"><input type="checkbox" x-model="approvedOnly"> <span>Approved</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" x-model="installedOnly"> <span>Installed</span></label>
        </div>
      </div>
    </div>

    <!-- Quick filters -->
    <div class="flex flex-wrap items-center gap-2 mb-5 no-print" x-show="apps.length">
      <span class="text-sm font-semibold text-gray-700">Quick filters:</span>
      <button @click="togglePill('free')"      :class="pillClass('free')"      class="px-3 py-1.5 rounded-full text-sm border">Free</button>
      <button @click="togglePill('short')"     :class="pillClass('short')"     class="px-3 py-1.5 rounded-full text-sm border">â‰¤ 15 min</button>
      <button @click="togglePill('hands')"     :class="pillClass('hands')"     class="px-3 py-1.5 rounded-full text-sm border">Hands</button>
      <button @click="togglePill('lowmotion')" :class="pillClass('lowmotion')" class="px-3 py-1.5 rounded-full text-sm border">Low motion</button>
      <button @click="togglePill('quest3')"    :class="pillClass('quest3')"    class="px-3 py-1.5 rounded-full text-sm border">Quest 3</button>
      <button @click="clearAll()" class="ml-2 text-xs underline">Clear all</button>
      <span class="ml-auto text-xs text-gray-500" x-text="filteredApps.length + ' results'"></span>
    </div>

    <!-- Cards -->
    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3" x-show="apps.length">
      <template x-for="(app, index) in filteredApps" :key="index">
        <div class="bg-white border rounded-xl shadow-sm overflow-hidden flex flex-col">
          <template x-if="app.logo"><img :src="app.logo" alt="" class="h-44 object-cover w-full" loading="lazy" width="640" height="176"></template>

          <div class="p-4 flex-1 flex flex-col">
            <div class="flex items-start gap-2">
              <h2 class="text-lg font-semibold flex-1 leading-snug" x-text="app.title"></h2>
              <template x-if="app.approved || app.installed">
                <span class="text-xs rounded px-2 py-1 border"
                      :class="app.installed ? 'border-green-300 text-green-800 bg-green-50' : 'border-blue-300 text-blue-800 bg-blue-50' "
                      x-text="app.installed ? 'Installed' : 'Approved'"></span>
              </template>
            </div>

            <div class="flex flex-wrap gap-2 mt-2 mb-3">
              <template x-for="d in parseDepts(app.department)" :key="d">
                <span class="text-xs px-2 py-0.5 rounded-full border text-gray-700" x-text="d"></span>
              </template>
            </div>

            <div class="flex flex-wrap gap-2 mb-3">
              <template x-if="facet(app, 'free')"><span class="text-[11px] px-2 py-0.5 rounded-full border">Free</span></template>
              <template x-if="typeof app.time_min==='number' && app.time_min>0">
                <span class="text-[11px] px-2 py-0.5 rounded-full border" x-text="'Time: ' + app.time_min + ' min'"></span>
              </template>
              <template x-if="(app.input || facet(app,'hands') || facet(app,'controllers'))">
                <span class="text:[11px] px-2 py-0.5 rounded-full border" x-text="'Input: ' + (app.input || (facet(app,'hands')?'Hands':(facet(app,'controllers')?'Controllers':'â€“')))"></span>
              </template>
              <template x-if="(app.comfort || facet(app,'seated') || facet(app,'room') || facet(app,'standing'))">
                <span class="text-[11px] px-2 py-0.5 rounded-full border" x-text="'Comfort: ' + (app.comfort || (facet(app,'seated')?'Seated':(facet(app,'room')?'Room-scale':(facet(app,'standing')?'Standing':'Unknown'))))"></span>
              </template>
            </div>

            <template x-if="app.description"><p class="text-sm text-gray-800 mb-2" x-text="app.description"></p></template>
            <template x-if="app.educational"><p class="text-sm text-blue-900 italic mb-2">ðŸ“˜ <span x-text="app.educational"></span></p></template>

            <div class="mt-auto flex items-center justify-between">
              <div class="text-xs text-gray-600 truncate" x-text="Array.isArray(app.tags) ? app.tags.join(', ') : (app.tags || '')"></div>
              <div class="flex items-center gap-3">
                <template x-if="app.link"><a :href="app.link" target="_blank" class="text-blue-600 hover:underline text-sm">View</a></template>
                <button class="text-sm underline no-print" @click="toggleDetails(index)" :aria-expanded="!!detailsOpen[index]" :aria-controls="'details-'+index" x-text="detailsOpen[index] ? 'Hide details' : 'Details'"></button>
              </div>
            </div>

            <div x-show="detailsOpen[index]" x-transition class="mt-3 border-t pt-3 text-sm text-gray-700" :id="'details-'+index">
              <dl class="grid grid-cols-2 gap-x-4 gap-y-1">
                <dt class="text-gray-500">Cost</dt><dd x-text="app.cost || 'Unknown'"></dd>
                <dt class="text-gray-500">Time</dt><dd x-text="(typeof app.time_min==='number' && app.time_min>0) ? (app.time_min + ' min') : 'Unknown'"></dd>
                <dt class="text-gray-500">Comfort</dt><dd x-text="app.comfort || 'Unknown'"></dd>
                <dt class="text-gray-500">Motion</dt><dd x-text="app.motion_level || 'Unknown'"></dd>
                <dt class="text-gray-500">Input</dt><dd x-text="app.input || 'Unknown'"></dd>
                <dt class="text-gray-500">Devices</dt><dd x-text="Array.isArray(app.devices) && app.devices.length ? app.devices.join(' â€¢ ') : 'Unknown'"></dd>
                <template x-if="app.age"><template><dt class="text-gray-500">Age</dt><dd x-text="app.age"></dd></template></template>
              </dl>

              <template x-if="app.content_notes"><p class="mt-3 text-xs text-gray-600" x-text="'Notes: ' + app.content_notes"></p></template>

              <p class="mt-2 text-xs text-gray-600">
                <span x-text="app.approved ? 'âœ… Approved' : 'â³ Not approved'"></span> â€¢
                <span x-text="app.installed ? 'ðŸ’¾ Installed' : 'Not installed'"></span>
              </p>

              <div class="mt-3 flex gap-3">
                <template x-if="app.link"><a :href="app.link" target="_blank" class="text-blue-600 hover:underline text-sm">Open store page</a></template>
                <button class="text-sm underline" @click="navigator.clipboard?.writeText(app.link || window.location.href)">Copy link</button>
              </div>
            </div>
          </div>
        </div>
      </template>
    </div>

    <p class="mt-6 text-xs text-gray-500" x-show="apps.length && !filteredApps.length">No results found.</p>
    <p class="mt-6 text-xs text-gray-400 italic" x-show="!apps.length">Loading app dataâ€¦</p>
  </div>

<script>
function app(){
  return {
    DATA: [],
    query: '',
    department: '',
    departmentOptions: [],
    deptCounts: {},
    sortMode: 'az',
    quickPills: new Set(),
    detailsOpen: {},
    approvedOnly: false,
    installedOnly: false,
    get apps(){ return this.DATA; },

    toText(v){ if(Array.isArray(v)) return v.map(this.toText.bind(this)).join(' '); return v==null?'':String(v); },
    parseDepts(v){ if(Array.isArray(v)) return v.map(x=>String(x).trim()).filter(Boolean); if(typeof v==='string') return v.split(/[,\|\/;]+/).map(s=>s.trim()).filter(Boolean); return []; },

    buildDepartmentOptions(){
      const counts={};
      for(const a of this.apps){ for(const d of this.parseDepts(a.department)){ counts[d]=(counts[d]||0)+1; } }
      this.deptCounts = counts;
      const names = Object.keys(counts);
      const collator = new Intl.Collator(undefined, {sensitivity:'base'});
      names.sort((a,b)=>counts[b]-counts[a] || collator.compare(a,b));
      this.departmentOptions = names;
    },
    deptOptionLabel(n){ return `${n} (${this.deptCounts[n]||0})`; },

    textBlob(app){
      return [app.title, app.description, app.educational, app.notes, app.tags, app.department]
        .map(this.toText.bind(this)).join(' ').toLowerCase();
    },
    facet(app,key){
      const t=this.textBlob(app);
      const devices=Array.isArray(app.devices)?app.devices.join(' ').toLowerCase():'';
      const cost=(app.cost||'').toLowerCase();
      const input=(app.input||'').toLowerCase();
      const motion=(app.motion_level||'').toLowerCase();
      switch(key){
        case 'free': return cost==='free' || /\bfree\b|no\s*cost/.test(t);
        case 'short': return (typeof app.time_min==='number' && app.time_min<=15) || /\b(10|12|15)\s*(min|minutes)\b|\bshort\b/.test(t);
        case 'hands': return input==='hands' || input==='both' || /\bhand(?:s)?\b|hand[-\s]?tracking/.test(t);
        case 'lowmotion': return motion==='low' || (/\bseated\b/.test(t) && !/\b(locomotion|free movement|stick movement)\b/.test(t));
        case 'quest3': return /quest\s*3/.test(devices) || /\bquest\s*3\b|meta\s*quest\s*3/.test(t);
        default: return false;
      }
    },
    pillClass(k){ return this.quickPills.has(k)?'bg-blue-600 text-white border-blue-600':'bg-white text-gray-800'; },
    togglePill(k){ this.quickPills.has(k)?this.quickPills.delete(k):this.quickPills.add(k); },
    clearAll(){ this.quickPills.clear(); this.query=''; this.department=''; this.sortMode='az'; this.approvedOnly=false; this.installedOnly=false; },

    // Core: Library visibility rule
    // Only show if approved OR installed is true.
    visibleInLibrary(app){ return !!(app && (app.approved === true || app.installed === true)); },

    get filteredApps(){
      const q=this.query.toLowerCase();
      let out=this.apps.filter(a => this.visibleInLibrary(a));
      const matchesPills = (a)=>{ for(const p of this.quickPills) if(!this.facet(a,p)) return false; return true; };
      out = out.filter(a => matchesPills(a));

      // Optional extra narrowing (within the visible set)
      if(this.approvedOnly) out = out.filter(a => a.approved === true);
      if(this.installedOnly) out = out.filter(a => a.installed === true);

      // Department + search
      out = out.filter(a => {
        const depts=this.parseDepts(a.department);
        const matchesDept=!this.department || depts.includes(this.department);
        const matchesQuery=!q || this.textBlob(a).includes(q);
        return matchesDept && matchesQuery;
      });

      const collator=new Intl.Collator(undefined,{sensitivity:'base'});
      out=[...out].sort((a,b)=> this.sortMode==='za'
        ? collator.compare((b.title||''),(a.title||''))
        : collator.compare((a.title||''),(b.title||'')));
      return out;
    },

    async loadData(){
      try{
        const res = await fetch('app_library.json');
        const raw = await res.json();

        // Normalize booleans and keep everything else
        const data = raw.map((item,i)=>({
          ...item,
          approved: item.approved === true,
          installed: item.installed === true,
          _idx: i
        }));

        this.DATA = data;
        this.buildDepartmentOptions();
      }catch(e){ console.error('Failed to load app_library.json', e); }
    }
  }
}
</script>
</body>
</html>
